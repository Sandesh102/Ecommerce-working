{% extends 'products/base.html' %}
{% load static %}
{% load custom_filters %}
{% block head %}
    <meta property="og:title" content="{{ product.name|replace_underscore }}">
    <meta property="og:description" content="{{ product.description }}">
    <meta property="og:image" content="{{ product.image.url }}">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:type" content="product">
{% endblock %}

{% block css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet" href="{% static 'products/css/detail.css' %}">
<link rel="stylesheet" href="{% static 'products/css/detail_share.css' %}">
{% endblock %}

{% block start %}

<div class="container my-5">
    <div class="card shadow p-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <!-- Image Slider -->
                <div class="product-image-slider">
                    <div class="main-image-container">
                        <img id="mainImage" src="{{ product.image.url }}" alt="{{ product.name|replace_underscore }}">
                        {% if product.image2 or product.image3 %}
                        <button class="slider-nav prev" onclick="changeImage(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="slider-nav next" onclick="changeImage(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        {% endif %}
                    </div>
                    <div class="thumbnail-container">
                        <div class="thumbnail active" onclick="showImage(0)">
                            <img src="{{ product.image.url }}" alt="Main image">
                        </div>
                        {% if product.image2 %}
                        <div class="thumbnail" onclick="showImage(1)">
                            <img src="{{ product.image2.url }}" alt="Image 2">
                        </div>
                        {% endif %}
                        {% if product.image3 %}
                        <div class="thumbnail" onclick="showImage(2)">
                            <img src="{{ product.image3.url }}" alt="Image 3">
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h2 class="fw-bold">{{ product.name|replace_underscore }}</h2>
                <p class="text-muted">{{ product.description }}</p>
                <h4 class="text-green">Rs. {{ product.price }}</h4>

                <form method="POST" action="{% url 'add_to_cart' product.id %}">
                    {% csrf_token %}
                    <div class="d-flex align-items-center mb-4">
                        <label for="quantity" class="me-3">Quantity:</label>
                        <input type="number" id="quantity" name="quantity" min="1" value="1" class="form-control w-25">
                    </div>
                    {% if user.is_authenticated %}
                    <button type="submit" class="btn btn-primary btn-primary-theme">Add to Cart</button>
                    {% else %}
                    <a href="{% url 'login' %}" class="btn btn-primary btn-primary-theme">Login to Add to Cart</a>
                    {% endif %}
        

                </form>
                <br/>

                <div class="share-button-container">
                    <button class="share-button btn-primary-theme" onclick="toggleShareOptions()">
                      <i class="fa fa-share-alt"></i>
                    </button>
                  
                    <div id="shareOptions" class="share-options">
                      <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="share-option-link facebook">
                        <i class="fa fa-facebook"></i> Facebook
                      </a>
                      <a href="https://www.instagram.com/" target="_blank" class="share-option-link instagram">
                        <i class="fa fa-instagram"></i> Instagram
                      </a>
                      <a href="https://www.linkedin.com/shareArticle?url={{ request.build_absolute_uri }}" target="_blank" class="share-option-link linkedin">
                        <i class="fa fa-linkedin"></i> LinkedIn
                      </a>
                      <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}" target="_blank" class="share-option-link twitter">
                        <i class="fa fa-twitter"></i> Twitter
                      </a>
                    </div>
                  
                    <script>
                      function toggleShareOptions() {
                        const shareOptions = document.getElementById('shareOptions');
                        shareOptions.style.display = shareOptions.style.display === 'block' ? 'none' : 'block';
                      }
                  
                      document.addEventListener('click', function(event) {
                        const shareOptions = document.getElementById('shareOptions');
                        const shareIcon = document.querySelector('button[onclick="toggleShareOptions()"]');
                        if (!shareIcon.contains(event.target) && !shareOptions.contains(event.target)) {
                          shareOptions.style.display = 'none';
                        }
                      });
                    </script>
                  </div>
                  
            </div>
        </div>
    </div>

    <!-- Same Category Products Section -->
    {% if same_category_products %}
    <div class="same-category-section">
        <h3>More from {{ product.category.name }}</h3>
        <div class="row">
            {% for related_product in same_category_products %}
            <div class="col-md-3 col-sm-6 mb-4">
                <div class="product-card-item">
                    <a href="{% url 'product_detail' related_product.slug %}" style="text-decoration: none; color: inherit;">
                        <img src="{{ related_product.image.url }}" alt="{{ related_product.name|replace_underscore }}">
                        <div class="card-body">
                            <h5>{{ related_product.name|replace_underscore }}</h5>
                            <p class="price">Rs. {{ related_product.price }}</p>
                            <a href="{% url 'product_detail' related_product.slug %}" class="btn btn-sm">
                                View Details
                            </a>
                        </div>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Image slider functionality
    const images = [
        { src: "{{ product.image.url }}", alt: "{{ product.name|replace_underscore }}" }
    ];
    {% if product.image2 %}
    images.push({ src: "{{ product.image2.url }}", alt: "Image 2" });
    {% endif %}
    {% if product.image3 %}
    images.push({ src: "{{ product.image3.url }}", alt: "Image 3" });
    {% endif %}

    let currentImageIndex = 0;

    function showImage(index) {
        if (index < 0 || index >= images.length) return;
        
        currentImageIndex = index;
        const mainImage = document.getElementById('mainImage');
        mainImage.src = images[index].src;
        mainImage.alt = images[index].alt;

        // Update active thumbnail
        const thumbnails = document.querySelectorAll('.thumbnail');
        thumbnails.forEach((thumb, i) => {
            if (i === index) {
                thumb.classList.add('active');
            } else {
                thumb.classList.remove('active');
            }
        });
    }

    function changeImage(direction) {
        let newIndex = currentImageIndex + direction;
        if (newIndex < 0) {
            newIndex = images.length - 1;
        } else if (newIndex >= images.length) {
            newIndex = 0;
        }
        showImage(newIndex);
    }

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft') {
            changeImage(-1);
        } else if (e.key === 'ArrowRight') {
            changeImage(1);
        }
    });

    // Auto-slide functionality (optional)
    // let autoSlideInterval;
    // function startAutoSlide() {
    //     autoSlideInterval = setInterval(() => {
    //         if (images.length > 1) {
    //             changeImage(1);
    //         }
    //     }, 3000);
    // }
    // function stopAutoSlide() {
    //     clearInterval(autoSlideInterval);
    // }
    // if (images.length > 1) {
    //     startAutoSlide();
    //     document.querySelector('.product-image-slider').addEventListener('mouseenter', stopAutoSlide);
    //     document.querySelector('.product-image-slider').addEventListener('mouseleave', startAutoSlide);
    // }
</script>
{% endblock %}
